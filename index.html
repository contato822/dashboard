<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BestBarbers â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Clash+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ RESET & VARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --ink: #0c0c10;
  --ink2: #16161d;
  --ink3: #1e1e28;
  --ink4: #272734;
  --fog: #3a3a50;
  --mist: #5a5a78;
  --smoke: #8888aa;
  --pale: #c8c8e0;
  --white: #f0f0f8;
  --lime: #b8f04a;
  --cyan: #4af0e0;
  --rose: #f04a7a;
  --gold: #f0c84a;
  --violet: #8a6aff;
  --mono: 'DM Mono', monospace;
  --display: 'Clash Display', sans-serif;
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { font-size:14px; }
body {
  background: var(--ink);
  color: var(--white);
  font-family: var(--mono);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€ SCANLINE TEXTURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::before {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 9999;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,0,0,0.03) 2px,
    rgba(0,0,0,0.03) 4px
  );
}

/* â”€â”€ GLOW ORBS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.orb {
  position: fixed; border-radius: 50%; filter: blur(120px);
  pointer-events: none; z-index: 0;
}
.orb-1 { width:500px; height:500px; top:-100px; left:-100px; background:rgba(184,240,74,0.04); }
.orb-2 { width:400px; height:400px; bottom:-80px; right:-80px; background:rgba(74,240,224,0.04); }

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.shell { display:flex; min-height:100vh; position:relative; z-index:1; }

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: 200px; flex-shrink: 0;
  background: var(--ink2);
  border-right: 1px solid rgba(255,255,255,0.05);
  display: flex; flex-direction: column;
  position: sticky; top: 0; height: 100vh;
}
.brand {
  padding: 24px 20px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.brand-mark {
  width: 36px; height: 36px;
  background: var(--lime); border-radius: 8px;
  display: flex; align-items:center; justify-content:center;
  font-size: 18px; margin-bottom: 10px;
}
.brand-name {
  font-family: var(--display);
  font-size: 15px; font-weight: 700;
  color: var(--white); line-height:1.2;
}
.brand-sub { font-size: 10px; color: var(--mist); margin-top:2px; letter-spacing:.5px; }

.nav { padding: 12px 0; flex: 1; }
.nav-item {
  display: flex; align-items: center; gap: 8px;
  padding: 9px 20px;
  font-size: 12px; font-weight: 500; color: var(--mist);
  cursor: pointer; transition: all .15s;
  border-left: 2px solid transparent;
  user-select: none;
}
.nav-item:hover { color: var(--pale); background: rgba(255,255,255,0.03); }
.nav-item.active { color: var(--lime); border-left-color: var(--lime); background: rgba(184,240,74,0.05); }
.nav-icon { font-size: 14px; width: 18px; text-align:center; }

.sidebar-foot {
  padding: 16px 20px;
  border-top: 1px solid rgba(255,255,255,0.05);
}
.sync-row { display:flex; align-items:center; gap:6px; font-size:10px; color:var(--mist); }
.blink { width:6px; height:6px; border-radius:50%; background:var(--mist); }
.blink.on { background:var(--lime); animation: blink 2s infinite; }
.blink.err { background:var(--rose); }
@keyframes blink { 0%,100%{opacity:1}50%{opacity:.3} }
.btn-sync {
  margin-top: 10px; width: 100%;
  padding: 8px; background: var(--ink3);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 6px; color: var(--smoke);
  font-family: var(--mono); font-size: 11px; cursor: pointer;
  transition: all .2s;
}
.btn-sync:hover { border-color: var(--lime); color: var(--lime); }

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { flex: 1; padding: 28px 28px 48px; overflow: hidden; }

/* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar {
  display: flex; align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 28px;
}
.page-title {
  font-family: var(--display);
  font-size: 26px; font-weight: 700;
  line-height: 1;
}
.page-meta { font-size: 11px; color: var(--mist); margin-top: 6px; }
.topbar-right { display:flex; align-items:center; gap:10px; }
.chip {
  padding: 4px 10px; border-radius: 4px;
  font-size: 10px; font-weight: 500; letter-spacing: .5px;
  text-transform: uppercase;
}
.chip-green { background: rgba(184,240,74,.12); color:var(--lime); border:1px solid rgba(184,240,74,.2); }
.chip-gray  { background: var(--ink3); color:var(--mist); border:1px solid rgba(255,255,255,.06); }
.chip-red   { background: rgba(240,74,122,.1); color:var(--rose); border:1px solid rgba(240,74,122,.2); }
.countdown-txt { font-size:11px; color:var(--fog); }
.countdown-txt span { color:var(--gold); }

/* â”€â”€ KPI GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:22px; }
@media(max-width:1100px){ .kpi-grid{ grid-template-columns:repeat(2,1fr); } }

.kpi {
  background: var(--ink2);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 12px; padding: 20px;
  position: relative; overflow: hidden;
  transition: border-color .2s;
  animation: fadeUp .5s ease both;
}
.kpi:hover { border-color: rgba(255,255,255,.1); }
.kpi::after {
  content: '';
  position: absolute; top:0; left:0; right:0; height:1px;
  background: var(--kpi-color, var(--lime));
  opacity: .6;
}
.kpi-emoji { font-size:20px; margin-bottom:10px; }
.kpi-label { font-size:10px; color:var(--mist); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:8px; }
.kpi-value {
  font-family: var(--display); font-size:30px; font-weight:700;
  color: var(--kpi-color, var(--white)); line-height:1;
}
.kpi-sub { font-size:10px; color:var(--fog); margin-top:8px; }

@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

/* â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sec-label {
  font-size: 10px; color: var(--fog); letter-spacing: 2px;
  text-transform: uppercase; margin-bottom: 12px;
  display:flex; align-items:center; gap: 10px;
}
.sec-label::after { content:''; flex:1; height:1px; background:rgba(255,255,255,.05); }

/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--ink2);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 12px; padding: 20px;
  animation: fadeUp .5s ease both;
}
.card-head {
  font-family: var(--display);
  font-size: 14px; font-weight: 600;
  margin-bottom: 16px; color: var(--pale);
  display: flex; align-items:center; gap:8px;
}

.grid2 { display:grid; grid-template-columns:1.6fr 1fr; gap:14px; margin-bottom:22px; }
.grid3 { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-bottom:22px; }
@media(max-width:900px){ .grid2,.grid3{ grid-template-columns:1fr; } }

/* â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tbl { width:100%; border-collapse:collapse; font-size:12px; }
.tbl th {
  text-align:left; padding:8px 10px;
  color:var(--mist); font-size:9px; letter-spacing:1.5px;
  text-transform:uppercase; border-bottom:1px solid rgba(255,255,255,.05);
  font-weight:500;
}
.tbl td { padding:9px 10px; border-bottom:1px solid rgba(255,255,255,.03); color:var(--pale); }
.tbl tr:last-child td { border-bottom:none; }
.tbl tr:hover td { background:rgba(255,255,255,.02); }
.scroll-x { overflow-x:auto; }
.scroll-y { max-height:280px; overflow-y:auto; }
.scroll-y::-webkit-scrollbar { width:3px; }
.scroll-y::-webkit-scrollbar-track { background:transparent; }
.scroll-y::-webkit-scrollbar-thumb { background:var(--ink4); border-radius:2px; }

/* â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge {
  display:inline-block; padding:2px 7px; border-radius:3px;
  font-size:9px; font-weight:500; letter-spacing:.5px; text-transform:uppercase;
}
.badge-green { background:rgba(184,240,74,.1); color:var(--lime); }
.badge-cyan  { background:rgba(74,240,224,.1); color:var(--cyan); }
.badge-rose  { background:rgba(240,74,122,.1); color:var(--rose); }
.badge-gold  { background:rgba(240,200,74,.1); color:var(--gold); }
.badge-violet{ background:rgba(138,106,255,.1); color:var(--violet); }

/* â”€â”€ BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bar-list { display:flex; flex-direction:column; gap:12px; }
.bar-row {}
.bar-meta { display:flex; justify-content:space-between; font-size:11px; margin-bottom:4px; }
.bar-name { color:var(--pale); }
.bar-val  { color:var(--smoke); font-family:var(--mono); }
.bar-track { height:4px; background:var(--ink4); border-radius:2px; overflow:hidden; }
.bar-fill  { height:100%; border-radius:2px; transition:width 1.2s cubic-bezier(.16,1,.3,1); }

/* â”€â”€ TIMELINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timeline { display:flex; flex-direction:column; gap:0; }
.tl-item {
  display:flex; gap:12px; padding:10px 0;
  border-bottom:1px solid rgba(255,255,255,.03);
}
.tl-item:last-child { border-bottom:none; }
.tl-dot {
  width:8px; height:8px; border-radius:50%;
  background:var(--ink4); border:1px solid var(--fog);
  flex-shrink:0; margin-top:4px;
}
.tl-dot.ok { background:var(--lime); border-color:var(--lime); }
.tl-content {}
.tl-title { font-size:12px; color:var(--pale); font-weight:500; }
.tl-sub { font-size:10px; color:var(--mist); margin-top:2px; }

/* â”€â”€ EMPTY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
  text-align:center; padding:48px 24px;
  border:1px dashed rgba(255,255,255,.08);
  border-radius:12px; color:var(--fog);
}
.empty-icon { font-size:40px; margin-bottom:14px; opacity:.5; }
.empty-title { font-family:var(--display); font-size:16px; color:var(--smoke); margin-bottom:8px; }
.empty-desc { font-size:12px; line-height:1.8; }
.empty-desc code { color:var(--lime); background:rgba(184,240,74,.1); padding:1px 5px; border-radius:3px; }

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position:fixed; bottom:24px; right:24px; z-index:9998;
  background:var(--ink3); border:1px solid rgba(255,255,255,.08);
  border-radius:10px; padding:12px 16px;
  display:flex; align-items:center; gap:10px;
  font-size:12px; opacity:0; pointer-events:none;
  transform:translateY(8px);
  transition:all .3s ease;
}
.toast.show { opacity:1; pointer-events:auto; transform:translateY(0); }

/* VIEWS */
.view { display:none; }
.view.active { display:block; }
</style>
</head>
<body>
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>

<div class="shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-mark">âœ‚ï¸</div>
      <div class="brand-name">BestBarbers</div>
      <div class="brand-sub">Dashboard Gerencial</div>
    </div>
    <nav class="nav">
      <div class="nav-item active" data-view="overview"><span class="nav-icon">â–¦</span> VisÃ£o Geral</div>
      <div class="nav-item" data-view="agendamentos"><span class="nav-icon">â—·</span> Agendamentos</div>
      <div class="nav-item" data-view="financeiro"><span class="nav-icon">â—ˆ</span> Financeiro</div>
      <div class="nav-item" data-view="barbeiros"><span class="nav-icon">â—</span> Barbeiros</div>
      <div class="nav-item" data-view="clientes"><span class="nav-icon">â—‰</span> Clientes</div>
      <div class="nav-item" data-view="historico"><span class="nav-icon">â‰¡</span> HistÃ³rico</div>
    </nav>
    <div class="sidebar-foot">
      <div class="sync-row">
        <div class="blink" id="blinkDot"></div>
        <span id="syncStatus">Conectando...</span>
      </div>
      <div style="font-size:10px;color:var(--fog);margin-top:4px" id="lastSyncTime"></div>
      <button class="btn-sync" onclick="buscar(true)">â†» Atualizar</button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div>
        <div class="page-title" id="pageTitle">VisÃ£o Geral</div>
        <div class="page-meta" id="pageMeta">Dados coletados pela extensÃ£o Chrome</div>
      </div>
      <div class="topbar-right">
        <span class="chip chip-gray" id="rotaChip">â€”</span>
        <span class="chip chip-green" id="statusChip">â— ao vivo</span>
        <span class="countdown-txt">sync em <span id="cdVal">60:00</span></span>
      </div>
    </div>

    <!-- VIEWS -->
    <div class="view active" id="view-overview"></div>
    <div class="view" id="view-agendamentos"></div>
    <div class="view" id="view-financeiro"></div>
    <div class="view" id="view-barbeiros"></div>
    <div class="view" id="view-clientes"></div>
    <div class="view" id="view-historico"></div>

  </main>
</div>

<div class="toast" id="toast">
  <span id="toastIcon">âœ“</span>
  <span id="toastMsg">Atualizado!</span>
</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// IMPORTANTE: apÃ³s deploy no Vercel, troque pela sua URL real
const API = 'https://dashboard-lemon-alpha-44.vercel.app/api';

let db = { coletas: [], ultimaAtualizacao: null };
let cdSec = 3600;
let cdTimer;
let activeView = 'overview';

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.nav-item').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    el.classList.add('active');
    activeView = el.dataset.view;
    document.getElementById('view-' + activeView).classList.add('active');
    const titles = {
      overview:'VisÃ£o Geral', agendamentos:'Agendamentos',
      financeiro:'Financeiro', barbeiros:'Barbeiros',
      clientes:'Clientes', historico:'HistÃ³rico de Coletas'
    };
    document.getElementById('pageTitle').textContent = titles[activeView];
    renderAll();
  });
});

// â”€â”€ FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buscar(manual = false) {
  try {
    const r = await fetch(API + '/dados', { signal: AbortSignal.timeout(10000) });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    db = await r.json();
    dot('on'); status('Online');
    if (db.ultimaAtualizacao) {
      document.getElementById('lastSyncTime').textContent =
        'Ãšltimo: ' + new Date(db.ultimaAtualizacao).toLocaleString('pt-BR');
    }
    renderAll();
    resetCd();
    if (manual) toast('âœ“', 'Dados atualizados!');
  } catch(e) {
    dot('err'); status('Sem dados ainda');
    
    
    if (manual) toast('âš ', 'API offline. Verifique o Vercel.', true);
    renderAll();
  }
}

function dot(s) { document.getElementById('blinkDot').className = 'blink ' + s; }
function status(s) { document.getElementById('syncStatus').textContent = s; }

// â”€â”€ COUNTDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetCd() {
  cdSec = 3600;
  clearInterval(cdTimer);
  cdTimer = setInterval(() => {
    cdSec--;
    if (cdSec <= 0) { buscar(); return; }
    const m = String(Math.floor(cdSec/60)).padStart(2,'0');
    const s = String(cdSec%60).padStart(2,'0');
    document.getElementById('cdVal').textContent = m+':'+s;
  }, 1000);
}

// â”€â”€ MÃ‰TRICAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function metricas() {
  if (!db.coletas?.length) return null;
  const ultima = db.coletas[0];
  const allCards = db.coletas.flatMap(c => c.cards || []);
  const allTabelas = db.coletas.flatMap(c => c.tabelas || []);

  // Tenta extrair valores dos cards
  let faturamento = null, agendamentos = null, clientes = null, barbeiros = null;
  allCards.forEach(card => {
    const txt = ((card.titulo||'') + ' ' + (card.valor||'') + ' ' + (card.textoCompleto||'')).toLowerCase();
    const raw = (card.valor || card.textoCompleto || '').replace(/[R$\s]/g,'').replace(',','.');
    const num = parseFloat(raw);
    if (isNaN(num)) return;
    if (/fatur|receita|R\$|caixa|total.*valor/i.test(txt) && !faturamento) faturamento = num;
    if (/agend|reserva|booking|schedule/i.test(txt) && !agendamentos) agendamentos = num;
    if (/cliente|customer/i.test(txt) && !clientes) clientes = num;
    if (/barbeiro|profissional|barber/i.test(txt) && !barbeiros) barbeiros = num;
  });

  // Fallback: contar linhas de tabelas relevantes
  if (!agendamentos) {
    const t = allTabelas.find(t => t.headers?.some(h => /agend|horÃ¡rio|nome|cliente/i.test(h)));
    if (t) agendamentos = t.linhas?.length;
  }

  // ConstrÃ³i sÃ©rie de histÃ³rico (Ãºltimas 10 coletas com timestamp)
  const serie = db.coletas.slice(0,10).map(c => ({
    label: c.dataColeta?.split(' ')[1] || 'â€”',
    data: c.dataColeta,
    rota: c.rota,
    tabelas: c.meta?.totalTabelas || 0,
    cards: c.meta?.totalCards || 0,
    linhas: c.meta?.totalLinhasTabelas || 0
  }));

  return {
    ultima, allCards, allTabelas,
    faturamento, agendamentos, clientes, barbeiros,
    serie,
    totalColetas: db.coletas.length,
    fmtFat: faturamento != null
      ? 'R$ ' + faturamento.toLocaleString('pt-BR', {minimumFractionDigits:2})
      : 'â€”',
    fmtAgend: agendamentos != null ? String(Math.round(agendamentos)) : 'â€”',
    fmtCli:   clientes    != null ? String(Math.round(clientes))    : 'â€”',
    fmtBarb:  barbeiros   != null ? String(Math.round(barbeiros))   : 'â€”',
  };
}

// â”€â”€ RENDER ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  const m = metricas();
  document.getElementById('rotaChip').textContent = m?.ultima?.rota || 'â€”';

  if (!m) {
    document.querySelectorAll('.view').forEach(v => {
      v.innerHTML = emptyState();
    });
    return;
  }

  document.getElementById('view-overview').innerHTML     = viewOverview(m);
  document.getElementById('view-agendamentos').innerHTML = viewAgendamentos(m);
  document.getElementById('view-financeiro').innerHTML   = viewFinanceiro(m);
  document.getElementById('view-barbeiros').innerHTML    = viewBarbeiros(m);
  document.getElementById('view-clientes').innerHTML     = viewClientes(m);
  document.getElementById('view-historico').innerHTML    = viewHistorico(m);

  // Anima barras
  setTimeout(() => {
    document.querySelectorAll('.bar-fill[data-w]').forEach(el => {
      el.style.width = el.dataset.w + '%';
    });
  }, 100);
}

// â”€â”€ EMPTY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function emptyState() {
  return `<div class="empty-state">
    <div class="empty-icon">ğŸ“¡</div>
    <div class="empty-title">Aguardando dados da extensÃ£o</div>
    <div class="empty-desc">
      1. Abra <code>adm.bestbarbers.app</code> no Chrome<br>
      2. Clique no Ã­cone âœ‚ï¸ da extensÃ£o<br>
      3. <strong>Coletar Dados</strong> â†’ <strong>Enviar ao Dashboard</strong>
    </div>
  </div>`;
}

// â”€â”€ VIEW: OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function viewOverview(m) {
  const tPrincipal = m.allTabelas[0];
  return `
  <div class="kpi-grid">
    <div class="kpi" style="--kpi-color:var(--lime); animation-delay:.0s">
      <div class="kpi-emoji">ğŸ’°</div>
      <div class="kpi-label">Faturamento</div>
      <div class="kpi-value">${m.fmtFat}</div>
      <div class="kpi-sub">detectado nos dados</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--violet); animation-delay:.08s">
      <div class="kpi-emoji">ğŸ“…</div>
      <div class="kpi-label">Agendamentos</div>
      <div class="kpi-value">${m.fmtAgend}</div>
      <div class="kpi-sub">registros encontrados</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--cyan); animation-delay:.16s">
      <div class="kpi-emoji">ğŸ‘¥</div>
      <div class="kpi-label">Clientes</div>
      <div class="kpi-value">${m.fmtCli}</div>
      <div class="kpi-sub">identificados</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--gold); animation-delay:.24s">
      <div class="kpi-emoji">ğŸ”„</div>
      <div class="kpi-label">Coletas</div>
      <div class="kpi-value">${m.totalColetas}</div>
      <div class="kpi-sub">no histÃ³rico</div>
    </div>
  </div>

  ${tPrincipal ? `
  <div class="sec-label">Tabela Mais Recente</div>
  <div class="card" style="margin-bottom:22px; animation-delay:.3s">
    <div class="card-head">ğŸ“‹ ${tPrincipal.headers?.join(' Â· ') || 'Dados'} <span class="badge badge-green">${tPrincipal.linhas?.length} linhas</span></div>
    <div class="scroll-x"><div class="scroll-y">${renderTabela(tPrincipal)}</div></div>
  </div>` : ''}

  <div class="sec-label">Indicadores Coletados</div>
  <div class="card" style="animation-delay:.38s">
    <div class="card-head">ğŸƒ Cards detectados na pÃ¡gina</div>
    ${m.allCards.length > 0
      ? `<table class="tbl"><thead><tr><th>Indicador</th><th>Valor</th></tr></thead><tbody>
          ${m.allCards.slice(0,20).map(c=>`<tr>
            <td>${esc(c.titulo||'â€”')}</td>
            <td><span class="badge badge-green">${esc(c.valor||c.textoCompleto?.substring(0,50)||'â€”')}</span></td>
          </tr>`).join('')}
        </tbody></table>`
      : '<div style="color:var(--mist);font-size:12px;padding:8px 0">Nenhum indicador detectado. Navegue para uma pÃ¡gina com dados e colete novamente.</div>'
    }
  </div>`;
}

// â”€â”€ VIEW: AGENDAMENTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function viewAgendamentos(m) {
  const t = m.allTabelas.find(t =>
    t.headers?.some(h => /agend|horÃ¡rio|hora|data|nome|cliente|serviÃ§o/i.test(h))
  ) || m.allTabelas[0];

  return `
  <div class="kpi-grid">
    <div class="kpi" style="--kpi-color:var(--violet)">
      <div class="kpi-emoji">ğŸ“…</div>
      <div class="kpi-label">Agendamentos</div>
      <div class="kpi-value">${m.fmtAgend}</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--lime)">
      <div class="kpi-emoji">ğŸ“Š</div>
      <div class="kpi-label">Tabelas coletadas</div>
      <div class="kpi-value">${m.allTabelas.length}</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--gold)">
      <div class="kpi-emoji">ğŸ•</div>
      <div class="kpi-label">Ãšltima coleta</div>
      <div class="kpi-value" style="font-size:16px">${m.ultima.dataColeta?.split(' ')[1]||'â€”'}</div>
      <div class="kpi-sub">${m.ultima.dataColeta?.split(' ')[0]||''}</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--cyan)">
      <div class="kpi-emoji">ğŸ”</div>
      <div class="kpi-label">HistÃ³rico</div>
      <div class="kpi-value">${m.totalColetas}</div>
      <div class="kpi-sub">coletas salvas</div>
    </div>
  </div>
  <div class="sec-label">Lista de Agendamentos</div>
  <div class="card">
    ${t ? `<div class="card-head">ğŸ“‹ ${t.linhas?.length} registros</div>
      <div class="scroll-x"><div class="scroll-y">${renderTabela(t)}</div></div>`
    : `<div class="empty-state" style="border:none;padding:32px">
        <div class="empty-icon" style="font-size:28px">ğŸ“…</div>
        <div class="empty-title">Sem dados de agendamentos</div>
        <div class="empty-desc">Navegue para a seÃ§Ã£o de Agendamentos no BestBarbers e colete.</div>
      </div>`}
  </div>`;
}

// â”€â”€ VIEW: FINANCEIRO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function viewFinanceiro(m) {
  const fatCards = m.allCards.filter(c =>
    /fatur|receita|R\$|caixa|pagamento|valor/i.test((c.titulo||'')+(c.textoCompleto||''))
  );
  const tFin = m.allTabelas.find(t =>
    t.headers?.some(h => /valor|total|preÃ§o|pagamento|R\$/i.test(h))
  );

  // SÃ©rie de histÃ³rico para mini chart
  const serieVals = m.serie.map(s => s.linhas);
  const maxVal = Math.max(...serieVals, 1);

  return `
  <div class="kpi-grid">
    <div class="kpi" style="--kpi-color:var(--lime)">
      <div class="kpi-emoji">ğŸ’°</div>
      <div class="kpi-label">Faturamento</div>
      <div class="kpi-value" style="font-size:22px">${m.fmtFat}</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--gold)">
      <div class="kpi-emoji">ğŸ“ˆ</div>
      <div class="kpi-label">Indicadores financeiros</div>
      <div class="kpi-value">${fatCards.length}</div>
      <div class="kpi-sub">detectados</div>
    </div>
  </div>

  <div class="grid2">
    ${fatCards.length > 0 ? `
    <div class="card">
      <div class="card-head">ğŸ’µ MÃ©tricas financeiras detectadas</div>
      <table class="tbl"><thead><tr><th>Indicador</th><th>Valor</th></tr></thead><tbody>
        ${fatCards.map(c=>`<tr>
          <td>${esc(c.titulo||'â€”')}</td>
          <td><span class="badge badge-green">${esc(c.valor||'â€”')}</span></td>
        </tr>`).join('')}
      </tbody></table>
    </div>` : `<div class="card"><div class="empty-state" style="border:none;padding:24px">
      <div class="empty-icon" style="font-size:24px">ğŸ’°</div>
      <div class="empty-title">Sem dados financeiros</div>
      <div class="empty-desc">Navegue para seÃ§Ã£o financeira e colete.</div>
    </div></div>`}

    <div class="card">
      <div class="card-head">ğŸ“Š Registros por coleta</div>
      <div class="bar-list">
        ${m.serie.slice(0,8).map(s => `
        <div class="bar-row">
          <div class="bar-meta">
            <span class="bar-name">${esc(s.data?.substring(0,10)||'â€”')}</span>
            <span class="bar-val">${s.linhas} linhas</span>
          </div>
          <div class="bar-track">
            <div class="bar-fill" style="background:var(--lime);width:0" data-w="${Math.round((s.linhas/maxVal)*100)}"></div>
          </div>
        </div>`).join('')}
      </div>
    </div>
  </div>

  ${tFin ? `
  <div class="sec-label">Tabela Financeira</div>
  <div class="card">
    <div class="card-head">ğŸ“‹ ${tFin.linhas?.length} registros</div>
    <div class="scroll-x"><div class="scroll-y">${renderTabela(tFin)}</div></div>
  </div>` : ''}`;
}

// â”€â”€ VIEW: BARBEIROS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function viewBarbeiros(m) {
  const t = m.allTabelas.find(t =>
    t.headers?.some(h => /barbeiro|profissional|nome|atendimento/i.test(h))
  );
  const bCards = m.allCards.filter(c =>
    /barbeiro|profissional/i.test((c.titulo||'')+(c.textoCompleto||''))
  );

  return `
  <div class="kpi-grid">
    <div class="kpi" style="--kpi-color:var(--gold)">
      <div class="kpi-emoji">âœ‚ï¸</div>
      <div class="kpi-label">Barbeiros</div>
      <div class="kpi-value">${m.fmtBarb}</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--lime)">
      <div class="kpi-emoji">ğŸ“‹</div>
      <div class="kpi-label">Registros</div>
      <div class="kpi-value">${t?.linhas?.length || 'â€”'}</div>
    </div>
  </div>
  <div class="sec-label">Lista de Barbeiros</div>
  <div class="card">
    ${t ? `<div class="card-head">âœ‚ï¸ ${t.linhas?.length} profissionais</div>
      <div class="scroll-x"><div class="scroll-y">${renderTabela(t)}</div></div>`
    : `<div class="empty-state" style="border:none;padding:32px">
        <div class="empty-icon" style="font-size:28px">âœ‚ï¸</div>
        <div class="empty-title">Sem dados de barbeiros</div>
        <div class="empty-desc">Navegue para a seÃ§Ã£o de Barbeiros e colete.</div>
      </div>`}
  </div>
  ${bCards.length > 0 ? `
  <div class="sec-label" style="margin-top:22px">Performance</div>
  <div class="card">
    <div class="card-head">ğŸ“Š Indicadores por barbeiro</div>
    <div class="bar-list">
      ${bCards.slice(0,8).map((c,i) => {
        const pct = Math.max(20, 100 - i*12);
        return `<div class="bar-row">
          <div class="bar-meta">
            <span class="bar-name">${esc(c.titulo||'Barbeiro '+(i+1))}</span>
            <span class="bar-val">${esc(c.valor||'â€”')}</span>
          </div>
          <div class="bar-track">
            <div class="bar-fill" style="background:var(--gold);width:0" data-w="${pct}"></div>
          </div>
        </div>`;
      }).join('')}
    </div>
  </div>` : ''}`;
}

// â”€â”€ VIEW: CLIENTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function viewClientes(m) {
  const t = m.allTabelas.find(t =>
    t.headers?.some(h => /cliente|nome|telefone|email|contato/i.test(h))
  );
  return `
  <div class="kpi-grid">
    <div class="kpi" style="--kpi-color:var(--cyan)">
      <div class="kpi-emoji">ğŸ‘¥</div>
      <div class="kpi-label">Clientes</div>
      <div class="kpi-value">${m.fmtCli}</div>
    </div>
    <div class="kpi" style="--kpi-color:var(--lime)">
      <div class="kpi-emoji">ğŸ“‹</div>
      <div class="kpi-label">Registros</div>
      <div class="kpi-value">${t?.linhas?.length || 'â€”'}</div>
    </div>
  </div>
  <div class="sec-label">Lista de Clientes</div>
  <div class="card">
    ${t ? `<div class="card-head">ğŸ‘¥ ${t.linhas?.length} clientes</div>
      <div class="scroll-x"><div class="scroll-y">${renderTabela(t)}</div></div>`
    : `<div class="empty-state" style="border:none;padding:32px">
        <div class="empty-icon" style="font-size:28px">ğŸ‘¥</div>
        <div class="empty-title">Sem dados de clientes</div>
        <div class="empty-desc">Navegue para a seÃ§Ã£o de Clientes e colete.</div>
      </div>`}
  </div>`;
}

// â”€â”€ VIEW: HISTÃ“RICO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function viewHistorico(m) {
  return `
  <div class="sec-label">Todas as Coletas</div>
  <div class="card">
    <div class="card-head">ğŸ—‚ ${m.totalColetas} coletas registradas</div>
    <div class="scroll-y" style="max-height:500px">
      <div class="timeline">
        ${db.coletas.map((c,i) => `
        <div class="tl-item">
          <div class="tl-dot ${i===0?'ok':''}"></div>
          <div class="tl-content">
            <div class="tl-title">
              <span class="badge badge-${i===0?'green':'violet'}">${esc(c.rota||'â€”')}</span>
              &nbsp;${esc(c.titulo||'â€”')}
            </div>
            <div class="tl-sub">
              ${esc(c.dataColeta||'â€”')} &middot;
              ${c.meta?.totalTabelas||0} tabela(s) &middot;
              ${c.meta?.totalCards||0} card(s) &middot;
              ${c.meta?.totalLinhasTabelas||0} linhas
            </div>
          </div>
        </div>`).join('')}
      </div>
    </div>
  </div>`;
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTabela(t) {
  if (!t?.linhas?.length) return '<p style="color:var(--mist);font-size:12px;padding:8px">Sem dados</p>';
  const headers = t.headers?.length > 0 ? t.headers : Object.keys(t.linhas[0]||{});
  const colors = ['badge-green','badge-cyan','badge-violet','badge-gold','badge-rose'];
  return `<table class="tbl">
    <thead><tr>${headers.map(h=>`<th>${esc(h)}</th>`).join('')}</tr></thead>
    <tbody>
      ${t.linhas.slice(0,30).map((row,ri) => {
        const vals = Array.isArray(row) ? row : headers.map(h=>row[h]||'');
        return `<tr>${vals.map((v,i)=>
          `<td>${i===0
            ? `<span class="badge ${colors[ri%5]}">${esc(String(v))}</span>`
            : esc(String(v||'â€”'))
          }</td>`
        ).join('')}</tr>`;
      }).join('')}
    </tbody>
  </table>
  ${t.linhas.length > 30 ? `<div style="color:var(--fog);font-size:10px;padding:8px 0">... +${t.linhas.length-30} registros</div>` : ''}`;
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function toast(icon, msg, err=false) {
  const el = document.getElementById('toast');
  document.getElementById('toastIcon').textContent = icon;
  document.getElementById('toastMsg').textContent = msg;
  el.style.borderColor = err ? 'rgba(240,74,122,.3)' : 'rgba(184,240,74,.2)';
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3500);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buscar();
setInterval(() => buscar(), 3600000);
</script>
</body>
</html>
